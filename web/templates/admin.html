<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8b4513">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† - Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ù…Ø¯ÛŒØ±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle">â˜°</button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order">â• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</a></li>
                <li><a href="/orders">ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li><a href="/admin" class="active">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="/dashboard" class="bottom-nav-item">
                <span class="icon">ğŸ“Š</span>
                Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
            </a>
            <a href="/new-order" class="bottom-nav-item">
                <span class="icon">â•</span>
                Ø³ÙØ§Ø±Ø´
            </a>
            <a href="/orders" class="bottom-nav-item">
                <span class="icon">ğŸ“‹</span>
                Ø³ÙØ§Ø±Ø´Ø§Øª
            </a>
            <a href="/admin" class="bottom-nav-item active">
                <span class="icon">ğŸ‘¥</span>
                Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            </a>
        </div>
    </nav>
    
    <div class="container">
        <div class="page-header">
            <h1>ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>
            <p>Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
        </div>
        
        <!-- Actions -->
        <div class="card">
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <button id="add-user-btn" class="btn btn-success" style="flex:1;min-width:150px;">
                    â• Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                </button>
                <button id="refresh-btn" class="btn btn-secondary" style="flex:1;min-width:150px;">
                    ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                </button>
            </div>
        </div>
        
        <!-- Users List -->
        <div id="users-container">
            <div class="card">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <!-- User Modal -->
    <div class="modal" id="user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</h2>
                <span class="modal-close" onclick="closeModal()">âœ•</span>
            </div>
            <form id="user-form">
                <div class="form-group">
                    <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                    <input type="text" id="form-username" class="form-control" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                    <input type="text" id="form-fullname" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input type="password" id="form-password" class="form-control" autocomplete="new-password">
                    <small style="color:#666;">Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Ù†Ù‚Ø´</label>
                    <select id="form-role" class="form-select">
                        <option value="cashier">ØµÙ†Ø¯ÙˆÙ‚Ø¯Ø§Ø±</option>
                        <option value="kitchen">Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡</option>
                        <option value="admin">Ù…Ø¯ÛŒØ±</option>
                    </select>
                </div>
                <div style="display:flex;gap:12px;margin-top:20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex:1;">
                        Ø§Ù†ØµØ±Ø§Ù
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">
                        Ø°Ø®ÛŒØ±Ù‡
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="alert alert-success" style="position:fixed;bottom:100px;left:50%;transform:translateX(-50%);z-index:9999;display:none;min-width:280px;text-align:center;"></div>
    
    <script src="/static/app.js"></script>
    <script>
        // Check authentication and admin role
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        const user = AuthManager.getUser();
        if (!user || user.role !== 'admin') {
            alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª');
            window.location.href = '/dashboard';
        }
        
        document.getElementById('user-info').textContent = user.full_name || user.username;
        
        // Mobile navigation toggle
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('mobile-hidden');
        });
        
        // Logout
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            AuthManager.logout();
            window.location.href = '/login';
        });
        
        // Users Manager
        const usersManager = new UsersManager();
        let currentUsers = [];
        let editingUserId = null;
        
        // Role names
        const roleNames = {
            'admin': 'ğŸ‘‘ Ù…Ø¯ÛŒØ±',
            'cashier': 'ğŸ’° ØµÙ†Ø¯ÙˆÙ‚Ø¯Ø§Ø±',
            'kitchen': 'ğŸ‘¨â€ğŸ³ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡'
        };
        
        // Load users
        async function loadUsers() {
            const container = document.getElementById('users-container');
            container.innerHTML = '<div class="card"><div class="spinner"></div></div>';
            
            try {
                const users = await usersManager.loadUsers();
                currentUsers = users || [];
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#666;padding:20px;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p></div>';
            }
        }
        
        // Render users
        function renderUsers() {
            const container = document.getElementById('users-container');
            
            if (currentUsers.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#666;padding:40px;">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p></div>';
                return;
            }
            
            container.innerHTML = currentUsers.map(u => `
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                        <div style="flex:1;min-width:200px;">
                            <h3 style="margin:0;color:var(--primary-color);">${u.full_name || u.username}</h3>
                            <p style="margin:4px 0;color:#666;">@${u.username}</p>
                            <p style="margin:4px 0;">
                                <span class="badge ${u.role === 'admin' ? 'badge-primary' : 'badge-info'}">
                                    ${roleNames[u.role] || u.role}
                                </span>
                                <span class="badge ${u.is_active ? 'badge-success' : 'badge-danger'}" style="margin-right:8px;">
                                    ${u.is_active ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                                </span>
                            </p>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <button class="btn btn-primary btn-sm" onclick="editUser(${u.id})">
                                âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´
                            </button>
                            ${u.id !== user.id ? `
                                <button class="btn btn-${u.is_active ? 'warning' : 'success'} btn-sm" onclick="toggleUserStatus(${u.id}, ${u.is_active})">
                                    ${u.is_active ? 'ğŸš« ØºÛŒØ±ÙØ¹Ø§Ù„' : 'âœ… ÙØ¹Ø§Ù„'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Show modal
        function showModal(title) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('user-modal').classList.add('show');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('user-modal').classList.remove('show');
            document.getElementById('user-form').reset();
            editingUserId = null;
        }
        
        // Add user button
        document.getElementById('add-user-btn').addEventListener('click', () => {
            editingUserId = null;
            document.getElementById('user-form').reset();
            document.getElementById('form-password').required = true;
            showModal('Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯');
        });
        
        // Edit user
        function editUser(userId) {
            const u = currentUsers.find(x => x.id === userId);
            if (!u) return;
            
            editingUserId = userId;
            document.getElementById('form-username').value = u.username;
            document.getElementById('form-fullname').value = u.full_name || '';
            document.getElementById('form-password').value = '';
            document.getElementById('form-password').required = false;
            document.getElementById('form-role').value = u.role;
            
            showModal('ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±');
        }
        
        // Toggle user status
        async function toggleUserStatus(userId, currentStatus) {
            const action = currentStatus ? 'ØºÛŒØ±ÙØ¹Ø§Ù„' : 'ÙØ¹Ø§Ù„';
            if (!confirm(`Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± ${action} Ø´ÙˆØ¯ØŸ`)) return;
            
            try {
                if (currentStatus) {
                    await usersManager.deactivateUser(userId);
                } else {
                    await usersManager.activateUser(userId);
                }
                showToast(`âœ… Ú©Ø§Ø±Ø¨Ø± ${action} Ø´Ø¯`);
                loadUsers();
            } catch (error) {
                console.error('Error toggling user status:', error);
                showToast('âŒ Ø®Ø·Ø§');
            }
        }
        
        // Form submit
        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('form-username').value.trim(),
                full_name: document.getElementById('form-fullname').value.trim(),
                role: document.getElementById('form-role').value
            };
            
            const password = document.getElementById('form-password').value;
            if (password) {
                userData.password = password;
            }
            
            try {
                if (editingUserId) {
                    await usersManager.updateUser(editingUserId, userData);
                    showToast('âœ… Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
                } else {
                    await usersManager.createUser(userData);
                    showToast('âœ… Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                }
                closeModal();
                loadUsers();
            } catch (error) {
                console.error('Error saving user:', error);
                showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡');
            }
        });
        
        // Show toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }
        
        // Refresh button
        document.getElementById('refresh-btn').addEventListener('click', loadUsers);
        
        // Close modal on background click
        document.getElementById('user-modal').addEventListener('click', (e) => {
            if (e.target.id === 'user-modal') closeModal();
        });
        
        // Make functions global
        window.editUser = editUser;
        window.toggleUserStatus = toggleUserStatus;
        window.closeModal = closeModal;
        
        // Load users on page load
        loadUsers();
    </script>
</body>
</html>
