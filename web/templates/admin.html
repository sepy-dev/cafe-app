<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† - Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ú©Ø§Ø±Ø¨Ø±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle" aria-label="Ù…Ù†ÙˆÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ">
                â˜°
            </button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order">â• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</a></li>
                <li><a href="/orders">ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li><a href="/admin" class="active">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <div style="margin: 30px 0;">
            <h1 style="color: var(--primary-color); margin-bottom: 10px;">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>
            <p style="color: var(--text-secondary);">Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³ÛŒØ³ØªÙ…</p>
        </div>
        
        <!-- Add User Button -->
        <div style="margin-bottom: 20px;">
            <button id="add-user-btn" class="btn btn-primary">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</button>
        </div>
        
        <!-- Users Table -->
        <div class="card">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</span>
                    <button id="refresh-btn" class="btn btn-primary btn-sm">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                </div>
            </div>
            <div class="card-body">
                <div id="users-container">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</h2>
                <span class="modal-close" onclick="closeUserModal()">Ã—</span>
            </div>
            <form id="user-form">
                <div class="form-group">
                    <label class="form-label" for="username">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                    <input type="text" id="username" class="form-control" required minlength="3">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input type="password" id="password" class="form-control" required minlength="4">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="full_name">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                    <input type="text" id="full_name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="role">Ù†Ù‚Ø´</label>
                    <select id="role" class="form-select" required>
                        <option value="cashier">ØµÙ†Ø¯ÙˆÙ‚Ø¯Ø§Ø±</option>
                        <option value="kitchen">Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡</option>
                        <option value="admin">Ù…Ø¯ÛŒØ±</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Check authentication and admin role
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        const user = AuthManager.getUser();
        if (!user || user.role !== 'admin') {
            alert('Ø§ÛŒÙ† ØµÙØ­Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±Ø§Ù† Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø³Øª');
            window.location.href = '/dashboard';
        }
        
        // Mobile navigation toggle
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('mobile-hidden');
        });
        
        // Close menu when clicking a link
        document.querySelectorAll('.navbar-menu a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navbar-menu').classList.add('mobile-hidden');
            });
        });
        
        // Users Manager
        const usersManager = new UsersManager();
        let currentUsers = [];
        
        // Load users
        async function loadUsers() {
            try {
                currentUsers = await usersManager.loadUsers();
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        // Render users
        function renderUsers() {
            const container = document.getElementById('users-container');
            
            if (currentUsers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }
            
            const currentUser = AuthManager.getUser();
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
                            <th>Ù†Ø§Ù… Ú©Ø§Ù…Ù„</th>
                            <th>Ù†Ù‚Ø´</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
                            <th>Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentUsers.map(u => `
                            <tr>
                                <td><strong>${u.username}</strong></td>
                                <td>${u.full_name}</td>
                                <td><span class="badge badge-info">${getRoleText(u.role)}</span></td>
                                <td>
                                    <span class="badge ${u.is_active ? 'badge-success' : 'badge-danger'}">
                                        ${u.is_active ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                                    </span>
                                </td>
                                <td>${UI.formatDate(u.created_at)}</td>
                                <td>${u.last_login ? UI.formatDate(u.last_login) : '-'}</td>
                                <td>
                                    ${u.id !== currentUser.id ? `
                                        <button class="btn btn-sm btn-warning" onclick="toggleUserActive(${u.id})">
                                            ${u.is_active ? 'ØºÛŒØ±ÙØ¹Ø§Ù„' : 'ÙØ¹Ø§Ù„'}
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Ø­Ø°Ù</button>
                                    ` : '<span style="color: var(--text-secondary);">Ø´Ù…Ø§</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }
        
        // Get role text
        function getRoleText(role) {
            const roleMap = {
                'admin': 'Ù…Ø¯ÛŒØ±',
                'cashier': 'ØµÙ†Ø¯ÙˆÙ‚Ø¯Ø§Ø±',
                'kitchen': 'Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡'
            };
            return roleMap[role] || role;
        }
        
        // Show add user modal
        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('user-form').reset();
            document.getElementById('user-modal').classList.add('show');
        });
        
        // Close user modal
        function closeUserModal() {
            document.getElementById('user-modal').classList.remove('show');
        }
        
        // Submit user form
        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                full_name: document.getElementById('full_name').value,
                role: document.getElementById('role').value
            };
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯...';
            
            try {
                await usersManager.createUser(userData);
                closeUserModal();
                await loadUsers();
            } catch (error) {
                console.error('Error creating user:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±';
            }
        });
        
        // Toggle user active status
        async function toggleUserActive(userId) {
            if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆØ¶Ø¹ÛŒØª Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŸ')) {
                return;
            }
            
            try {
                await usersManager.toggleUserActive(userId);
                await loadUsers();
            } catch (error) {
                console.error('Error toggling user status:', error);
            }
        }
        
        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
                return;
            }
            
            try {
                await usersManager.deleteUser(userId);
                await loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
            }
        }
        
        // Event listeners
        document.getElementById('refresh-btn').addEventListener('click', loadUsers);
        
        // Close modal on background click
        document.getElementById('user-modal').addEventListener('click', (e) => {
            if (e.target.id === 'user-modal') {
                closeUserModal();
            }
        });
        
        // Make functions global
        window.closeUserModal = closeUserModal;
        window.toggleUserActive = toggleUserActive;
        window.deleteUser = deleteUser;
        
        // Load users on page load
        loadUsers();
    </script>
</body>
</html>
