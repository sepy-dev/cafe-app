<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6F4E37">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† - Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ù…Ø¯ÛŒØ±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle">â˜°</button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order">â• Ø³ÙØ§Ø±Ø´</a></li>
                <li><a href="/orders">ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li><a href="/admin" class="active">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="/dashboard" class="bottom-nav-item">
                <span class="icon">ğŸ </span>
                Ø®Ø§Ù†Ù‡
            </a>
            <a href="/new-order" class="bottom-nav-item">
                <span class="icon">â•</span>
                Ø³ÙØ§Ø±Ø´
            </a>
            <a href="/orders" class="bottom-nav-item">
                <span class="icon">ğŸ“‹</span>
                Ø³ÙØ§Ø±Ø´Ø§Øª
            </a>
            <a href="/admin" class="bottom-nav-item active">
                <span class="icon">ğŸ‘¥</span>
                Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            </a>
        </div>
    </nav>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <div class="page-header">
            <h1>ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>
            <p>Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³ÛŒØ³ØªÙ…</p>
        </div>
        
        <!-- Actions -->
        <div class="card" style="padding:12px;">
            <div style="display:grid;grid-template-columns:1fr auto;gap:10px;">
                <button id="add-user-btn" class="btn btn-success">
                    â• Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                </button>
                <button id="refresh-btn" class="btn btn-secondary btn-icon">ğŸ”„</button>
            </div>
        </div>
        
        <!-- Users List -->
        <div id="users-container">
            <div class="card" style="padding:60px;">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <!-- User Modal -->
    <div class="modal" id="user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</h2>
                <span class="modal-close" onclick="closeModal()">âœ•</span>
            </div>
            <form id="user-form">
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                    <input type="text" id="form-username" class="form-control" required autocomplete="off" placeholder="Ù…Ø«Ù„Ø§Ù‹: ali">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“ Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                    <input type="text" id="form-fullname" class="form-control" required placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ”’ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input type="password" id="form-password" class="form-control" autocomplete="new-password" placeholder="Ø­Ø¯Ø§Ù‚Ù„ 6 Ú©Ø§Ø±Ø§Ú©ØªØ±">
                    <small style="color:#888;font-size:0.8rem;">Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯</small>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ­ Ù†Ù‚Ø´</label>
                    <select id="form-role" class="form-select">
                        <option value="cashier">ğŸ’° ØµÙ†Ø¯ÙˆÙ‚Ø¯Ø§Ø±</option>
                        <option value="kitchen">ğŸ‘¨â€ğŸ³ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡</option>
                        <option value="admin">ğŸ‘‘ Ù…Ø¯ÛŒØ±</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        âŒ Ø§Ù†ØµØ±Ø§Ù
                    </button>
                    <button type="submit" class="btn btn-primary">
                        âœ… Ø°Ø®ÛŒØ±Ù‡
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Auth
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        const currentUser = AuthManager.getUser();
        if (!currentUser || currentUser.role !== 'admin') {
            alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª');
            window.location.href = '/dashboard';
        }
        
        document.getElementById('user-info').textContent = currentUser.full_name || currentUser.username;
        
        // Navigation
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            document.getElementById('navbar-menu').classList.toggle('mobile-hidden');
        });
        
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            AuthManager.logout();
            window.location.href = '/login';
        });
        
        // Toast
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        // Data
        const usersManager = new UsersManager();
        let currentUsers = [];
        let editingUserId = null;
        
        const roleNames = {
            'admin': 'ğŸ‘‘ Ù…Ø¯ÛŒØ±',
            'cashier': 'ğŸ’° ØµÙ†Ø¯ÙˆÙ‚Ø¯Ø§Ø±',
            'kitchen': 'ğŸ‘¨â€ğŸ³ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡'
        };
        
        const roleColors = {
            'admin': 'badge-primary',
            'cashier': 'badge-info',
            'kitchen': 'badge-warning'
        };
        
        // Load users
        async function loadUsers() {
            const container = document.getElementById('users-container');
            container.innerHTML = '<div class="card" style="padding:60px;"><div class="spinner"></div></div>';
            
            try {
                const users = await usersManager.loadUsers();
                currentUsers = users || [];
                renderUsers();
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#888;padding:40px;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p></div>';
            }
        }
        
        function renderUsers() {
            const container = document.getElementById('users-container');
            
            if (currentUsers.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#888;padding:60px;">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p></div>';
                return;
            }
            
            container.innerHTML = currentUsers.map((u, i) => `
                <div class="card" style="animation-delay:${i*0.05}s;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
                        <div style="flex:1;min-width:180px;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="width:48px;height:48px;background:linear-gradient(135deg,#6F4E37,#4a3423);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:1.25rem;font-weight:700;">
                                    ${(u.full_name || u.username).charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 style="margin:0;font-size:1rem;color:#333;">${u.full_name || u.username}</h3>
                                    <p style="margin:2px 0 0;color:#888;font-size:0.85rem;">@${u.username}</p>
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                <span class="badge ${roleColors[u.role] || 'badge-info'}">
                                    ${roleNames[u.role] || u.role}
                                </span>
                                <span class="badge ${u.is_active ? 'badge-success' : 'badge-danger'}">
                                    ${u.is_active ? 'âœ… ÙØ¹Ø§Ù„' : 'âŒ ØºÛŒØ±ÙØ¹Ø§Ù„'}
                                </span>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <button class="btn btn-primary btn-sm" onclick="editUser(${u.id})">
                                âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´
                            </button>
                            ${u.id !== currentUser.id ? `
                                <button class="btn ${u.is_active ? 'btn-warning' : 'btn-success'} btn-sm" onclick="toggleUser(${u.id}, ${u.is_active})">
                                    ${u.is_active ? 'ğŸš«' : 'âœ…'}
                                </button>
                            ` : '<span class="badge badge-primary" style="align-self:center;">Ø´Ù…Ø§</span>'}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Modal
        function showModal(title) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('user-modal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('user-modal').classList.remove('show');
            document.getElementById('user-form').reset();
            editingUserId = null;
        }
        
        // Add user
        document.getElementById('add-user-btn').addEventListener('click', () => {
            editingUserId = null;
            document.getElementById('user-form').reset();
            document.getElementById('form-password').required = true;
            showModal('â• Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯');
        });
        
        // Edit user
        function editUser(userId) {
            const u = currentUsers.find(x => x.id === userId);
            if (!u) return;
            
            editingUserId = userId;
            document.getElementById('form-username').value = u.username;
            document.getElementById('form-fullname').value = u.full_name || '';
            document.getElementById('form-password').value = '';
            document.getElementById('form-password').required = false;
            document.getElementById('form-role').value = u.role;
            
            showModal('âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±');
        }
        
        // Toggle user status
        async function toggleUser(userId, isActive) {
            const action = isActive ? 'ØºÛŒØ±ÙØ¹Ø§Ù„' : 'ÙØ¹Ø§Ù„';
            if (!confirm(`Ú©Ø§Ø±Ø¨Ø± ${action} Ø´ÙˆØ¯ØŸ`)) return;
            
            try {
                if (isActive) {
                    await usersManager.deactivateUser(userId);
                } else {
                    await usersManager.activateUser(userId);
                }
                showToast(`âœ… Ú©Ø§Ø±Ø¨Ø± ${action} Ø´Ø¯`);
                loadUsers();
                if (navigator.vibrate) navigator.vibrate(50);
            } catch (error) {
                console.error('Error:', error);
                showToast('âŒ Ø®Ø·Ø§', 'error');
            }
        }
        
        // Form submit
        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                username: document.getElementById('form-username').value.trim(),
                full_name: document.getElementById('form-fullname').value.trim(),
                role: document.getElementById('form-role').value
            };
            
            const password = document.getElementById('form-password').value;
            if (password) data.password = password;
            
            try {
                if (editingUserId) {
                    await usersManager.updateUser(editingUserId, data);
                    showToast('âœ… Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
                } else {
                    await usersManager.createUser(data);
                    showToast('âœ… Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                }
                closeModal();
                loadUsers();
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            } catch (error) {
                console.error('Error:', error);
                showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡', 'error');
            }
        });
        
        // Events
        document.getElementById('refresh-btn').addEventListener('click', loadUsers);
        
        document.getElementById('user-modal').addEventListener('click', (e) => {
            if (e.target.id === 'user-modal') closeModal();
        });
        
        // Globals
        window.editUser = editUser;
        window.toggleUser = toggleUser;
        window.closeModal = closeModal;
        
        // Load
        loadUsers();
    </script>
</body>
</html>
