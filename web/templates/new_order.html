<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ú©Ø§Ø±Ø¨Ø±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle" aria-label="Ù…Ù†ÙˆÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ">
                â˜°
            </button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order" class="active">â• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</a></li>
                <li><a href="/orders">ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li id="admin-menu-item" style="display: none;"><a href="/admin">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Floating Cart Button for Mobile -->
    <div class="fab-container" id="fab-container">
        <button class="fab" id="fab-cart" aria-label="Ù†Ù…Ø§ÛŒØ´ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯">
            ğŸ›’
            <span class="fab-badge" id="fab-badge">0</span>
        </button>
    </div>
    
    <div class="container-fluid">
        <div style="margin: 30px 0;">
            <h1 style="color: var(--primary-color); margin-bottom: 10px;">â• Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</h1>
            <p style="color: var(--text-secondary);">Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;" id="main-grid">
            <!-- Products Section -->
            <div id="products-section">
                <!-- Category Filter -->
                <div class="card">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="category-filter">ğŸ·ï¸ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</label>
                        <select id="category-filter" class="form-select">
                            <option value="all">ğŸ“‹ Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option>
                        </select>
                    </div>
                </div>
                
                <!-- Products Grid -->
                <div class="card">
                    <div class="card-header">â˜• Ù…Ø­ØµÙˆÙ„Ø§Øª</div>
                    <div class="products-grid" id="products-grid">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Cart Section -->
            <div id="cart-section">
                <div class="order-cart" style="position: sticky; top: 80px;" id="order-cart">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ›’ Ø³Ø¨Ø¯ Ø³ÙØ§Ø±Ø´</h3>
                    
                    <!-- Table Number -->
                    <div class="form-group">
                        <label class="form-label" for="table-number">Ø´Ù…Ø§Ø±Ù‡ Ù…ÛŒØ² (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <input type="number" id="table-number" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: 5">
                    </div>
                    
                    <!-- Cart Items -->
                    <div id="cart-items" style="min-height: 200px; max-height: 400px; overflow-y: auto;">
                        <p style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
                            Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª<br>
                            Ù…Ø­ØµÙˆÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                        </p>
                    </div>
                    
                    <!-- Discount -->
                    <div class="form-group mt-2">
                        <label class="form-label" for="discount">ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" id="discount" class="form-control" value="0" min="0">
                    </div>
                    
                    <!-- Cart Total -->
                    <div class="cart-total">
                        <div class="cart-total-row">
                            <span>Ø¬Ù…Ø¹ Ø¬Ø²Ø¡:</span>
                            <span id="subtotal">0 ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <div class="cart-total-row">
                            <span>ØªØ®ÙÛŒÙ:</span>
                            <span id="discount-amount">0 ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <div class="cart-total-row final">
                            <span>Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ:</span>
                            <span id="total">0 ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="clear-cart-btn" class="btn btn-secondary" style="flex: 1;">
                            Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                        </button>
                        <button id="submit-order-btn" class="btn btn-success" style="flex: 2;">
                            Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Check authentication
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        // Show admin menu if user is admin
        const user = AuthManager.getUser();
        if (user && user.role === 'admin') {
            document.getElementById('admin-menu-item').style.display = 'block';
        }
        
        // Mobile navigation toggle
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('mobile-hidden');
        });
        
        // Close menu when clicking a link
        document.querySelectorAll('.navbar-menu a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navbar-menu').classList.add('mobile-hidden');
            });
        });
        
        // FAB cart button functionality
        const fabCart = document.getElementById('fab-cart');
        const cartSection = document.getElementById('cart-section');
        let cartVisible = false;
        
        fabCart.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                cartSection.style.display = cartVisible ? 'none' : 'block';
                cartVisible = !cartVisible;
                
                // Scroll to cart
                if (cartVisible) {
                    cartSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
        
        // Hide cart by default on mobile
        if (window.innerWidth <= 768) {
            cartSection.style.display = 'none';
        }
        
        // Show/hide FAB based on screen size
        function handleResize() {
            const fabContainer = document.getElementById('fab-container');
            if (window.innerWidth <= 768) {
                fabContainer.style.display = 'block';
                if (!cartVisible) {
                    cartSection.style.display = 'none';
                }
            } else {
                fabContainer.style.display = 'none';
                cartSection.style.display = 'block';
                cartVisible = false;
            }
        }
        
        window.addEventListener('resize', handleResize);
        handleResize();
        
        // Cart state
        const cart = [];
        
        // Products Manager
        const productsManager = new ProductsManager();
        const ordersManager = new OrdersManager();
        
        // Load products
        async function loadProducts() {
            try {
                await productsManager.loadProducts();
                populateCategoryFilter();
                renderProducts();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // Populate category filter
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('category-filter');
            const categories = productsManager.categories;
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            
            categoryFilter.addEventListener('change', () => renderProducts());
        }
        
        // Render products
        function renderProducts() {
            const container = document.getElementById('products-grid');
            const selectedCategory = document.getElementById('category-filter').value;
            const products = productsManager.getProductsByCategory(selectedCategory);
            
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Ù…Ø­ØµÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }
            
            container.innerHTML = products.map(product => `
                <div class="product-card" data-product-id="${product.id}">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${UI.formatCurrency(product.price)}</div>
                    <div class="product-category">${product.category}</div>
                </div>
            `).join('');
            
            // Add click handlers
            container.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', () => {
                    const productId = parseInt(card.dataset.productId);
                    addToCart(productId);
                });
            });
        }
        
        // Add product to cart
        function addToCart(productId) {
            const product = productsManager.getProductById(productId);
            if (!product) return;
            
            const existingItem = cart.find(item => item.product.id === productId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ product, quantity: 1 });
            }
            
            renderCart();
        }
        
        // Remove from cart
        function removeFromCart(productId) {
            const index = cart.findIndex(item => item.product.id === productId);
            if (index > -1) {
                cart.splice(index, 1);
            }
            renderCart();
        }
        
        // Update quantity
        function updateQuantity(productId, delta) {
            const item = cart.find(item => item.product.id === productId);
            if (!item) return;
            
            item.quantity += delta;
            
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                renderCart();
            }
        }
        
        // Render cart
        function renderCart() {
            const container = document.getElementById('cart-items');
            
            // Update FAB badge
            const fabBadge = document.getElementById('fab-badge');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            fabBadge.textContent = totalItems;
            fabBadge.style.display = totalItems > 0 ? 'flex' : 'none';
            
            if (cart.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª<br>Ù…Ø­ØµÙˆÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>';
                updateTotals();
                return;
            }
            
            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div>
                        <div style="font-weight: bold;">${item.product.name}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            ${UI.formatCurrency(item.product.price)}
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="updateQuantity(${item.product.id}, -1)">-</button>
                            <span style="min-width: 30px; text-align: center;">${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateQuantity(${item.product.id}, 1)">+</button>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.product.id})">Ã—</button>
                    </div>
                </div>
            `).join('');
            
            updateTotals();
        }
        
        // Update totals
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const discount = parseInt(document.getElementById('discount').value) || 0;
            const total = Math.max(0, subtotal - discount);
            
            document.getElementById('subtotal').textContent = UI.formatCurrency(subtotal);
            document.getElementById('discount-amount').textContent = UI.formatCurrency(discount);
            document.getElementById('total').textContent = UI.formatCurrency(total);
        }
        
        // Clear cart
        document.getElementById('clear-cart-btn').addEventListener('click', () => {
            if (cart.length === 0) return;
            if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø³Ø¨Ø¯ Ø±Ø§ Ø®Ø§Ù„ÛŒ Ú©Ù†ÛŒØ¯ØŸ')) {
                cart.length = 0;
                renderCart();
            }
        });
        
        // Discount input
        document.getElementById('discount').addEventListener('input', updateTotals);
        
        // Submit order
        document.getElementById('submit-order-btn').addEventListener('click', async () => {
            if (cart.length === 0) {
                UI.showError('Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                return;
            }
            
            const tableNumber = document.getElementById('table-number').value || null;
            const discount = parseInt(document.getElementById('discount').value) || 0;
            
            const orderData = {
                table_number: tableNumber ? parseInt(tableNumber) : null,
                discount: discount,
                items: cart.map(item => ({
                    product_id: item.product.id,
                    quantity: item.quantity
                }))
            };
            
            const submitBtn = document.getElementById('submit-order-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';
            
            try {
                await ordersManager.createOrder(orderData);
                cart.length = 0;
                renderCart();
                document.getElementById('table-number').value = '';
                document.getElementById('discount').value = '0';
                
                if (confirm('Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯. Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ù‡ ØµÙØ­Ù‡ Ø³ÙØ§Ø±Ø´Ø§Øª Ø¨Ø±ÙˆÛŒØ¯ØŸ')) {
                    window.location.href = '/orders';
                }
            } catch (error) {
                console.error('Error creating order:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´';
            }
        });
        
        // Make functions global for onclick handlers
        window.updateQuantity = updateQuantity;
        window.removeFromCart = removeFromCart;
        
        // Load data on page load
        loadProducts();
    </script>
</body>
</html>
