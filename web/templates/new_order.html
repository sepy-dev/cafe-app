<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#8b4513">
    <title>Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ú©Ø§Ø±Ø¨Ø±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle">â˜°</button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order" class="active">â• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</a></li>
                <li><a href="/orders">ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li id="admin-menu-item" style="display: none;"><a href="/admin">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="/dashboard" class="bottom-nav-item">
                <span class="icon">ğŸ“Š</span>
                Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
            </a>
            <a href="/new-order" class="bottom-nav-item active">
                <span class="icon">â•</span>
                Ø³ÙØ§Ø±Ø´
            </a>
            <a href="/orders" class="bottom-nav-item">
                <span class="icon">ğŸ“‹</span>
                Ø³ÙØ§Ø±Ø´Ø§Øª
            </a>
            <a href="#" class="bottom-nav-item" id="show-cart-btn">
                <span class="icon">ğŸ›’</span>
                Ø³Ø¨Ø¯
                <span class="fab-badge" id="cart-count" style="display:none;position:absolute;top:-2px;right:50%;transform:translateX(50%);">0</span>
            </a>
        </div>
    </nav>
    
    <!-- Floating Cart Button -->
    <div class="fab-container" id="fab-container">
        <button class="fab" id="fab-cart">
            ğŸ›’
            <span class="fab-badge" id="fab-badge" style="display:none;">0</span>
        </button>
    </div>
    
    <div class="container-fluid">
        <div class="order-page">
            <!-- Products Section -->
            <div class="order-products">
                <div class="page-header">
                    <h1>â• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</h1>
                    <p>Ù…Ø­ØµÙˆÙ„Ø§Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                </div>
                
                <!-- Category Filter -->
                <div class="card">
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="category-filter" class="form-select">
                            <option value="all">ğŸ“‹ Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option>
                        </select>
                    </div>
                </div>
                
                <!-- Products Grid -->
                <div class="products-grid" id="products-grid">
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Cart Section (Sidebar on Desktop, Bottom Sheet on Mobile) -->
            <div class="order-sidebar" id="cart-section">
                <div class="order-cart" id="order-cart">
                    <div class="cart-header">
                        <h3>ğŸ›’ Ø³Ø¨Ø¯ Ø³ÙØ§Ø±Ø´</h3>
                        <button class="btn btn-sm btn-secondary" id="close-cart-btn" style="display:none;">âœ•</button>
                    </div>
                    
                    <!-- Table Number -->
                    <div class="form-group">
                        <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ Ù…ÛŒØ²</label>
                        <select id="table-number" class="form-select">
                            <option value="">Ø¨Ø¯ÙˆÙ† Ù…ÛŒØ² (Ø¨ÛŒØ±ÙˆÙ†â€ŒØ¨Ø±)</option>
                            <option value="1">Ù…ÛŒØ² Û±</option>
                            <option value="2">Ù…ÛŒØ² Û²</option>
                            <option value="3">Ù…ÛŒØ² Û³</option>
                            <option value="4">Ù…ÛŒØ² Û´</option>
                            <option value="5">Ù…ÛŒØ² Ûµ</option>
                            <option value="6">Ù…ÛŒØ² Û¶</option>
                            <option value="7">Ù…ÛŒØ² Û·</option>
                            <option value="8">Ù…ÛŒØ² Û¸</option>
                            <option value="9">Ù…ÛŒØ² Û¹</option>
                            <option value="10">Ù…ÛŒØ² Û±Û°</option>
                        </select>
                    </div>
                    
                    <!-- Cart Items -->
                    <div class="cart-items" id="cart-items">
                        <div class="cart-empty">
                            <div class="icon">ğŸ›’</div>
                            <p>Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>
                            <small>Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</small>
                        </div>
                    </div>
                    
                    <!-- Discount -->
                    <div class="form-group mt-2">
                        <label class="form-label">ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" id="discount" class="form-control" value="0" min="0" inputmode="numeric">
                    </div>
                    
                    <!-- Cart Total -->
                    <div class="cart-total">
                        <div class="cart-total-row">
                            <span>Ø¬Ù…Ø¹:</span>
                            <span id="subtotal">Û° ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <div class="cart-total-row">
                            <span>ØªØ®ÙÛŒÙ:</span>
                            <span id="discount-amount">Û° ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <div class="cart-total-row final">
                            <span>Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ:</span>
                            <span id="total">Û° ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="cart-actions">
                        <button id="clear-cart-btn" class="btn btn-secondary">
                            ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                        </button>
                        <button id="submit-order-btn" class="btn btn-success">
                            âœ… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Toast -->
    <div id="toast" class="alert alert-success" style="position:fixed;bottom:100px;left:50%;transform:translateX(-50%);z-index:9999;display:none;min-width:280px;text-align:center;"></div>
    
    <script src="/static/app.js"></script>
    <script>
        // Check authentication
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        // Show admin menu if user is admin
        const user = AuthManager.getUser();
        if (user && user.role === 'admin') {
            document.getElementById('admin-menu-item').style.display = 'block';
        }
        
        // Mobile navigation toggle
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('mobile-hidden');
        });
        
        // Close menu when clicking a link
        document.querySelectorAll('.navbar-menu a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navbar-menu').classList.add('mobile-hidden');
            });
        });
        
        // Cart state
        const cart = [];
        const cartSection = document.getElementById('cart-section');
        const fabCart = document.getElementById('fab-cart');
        const showCartBtn = document.getElementById('show-cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        let isCartVisible = false;
        
        // Toggle cart visibility on mobile
        function toggleCart() {
            if (window.innerWidth <= 768) {
                isCartVisible = !isCartVisible;
                if (isCartVisible) {
                    cartSection.classList.add('visible');
                    closeCartBtn.style.display = 'block';
                } else {
                    cartSection.classList.remove('visible');
                    closeCartBtn.style.display = 'none';
                }
            }
        }
        
        fabCart.addEventListener('click', toggleCart);
        showCartBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleCart();
        });
        closeCartBtn.addEventListener('click', toggleCart);
        
        // Handle resize
        function handleResize() {
            if (window.innerWidth > 768) {
                cartSection.classList.remove('visible');
                closeCartBtn.style.display = 'none';
                isCartVisible = false;
            }
        }
        window.addEventListener('resize', handleResize);
        
        // Products Manager
        const productsManager = new ProductsManager();
        const ordersManager = new OrdersManager();
        
        // Load products
        async function loadProducts() {
            try {
                await productsManager.loadProducts();
                populateCategoryFilter();
                renderProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-grid').innerHTML = 
                    '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#666;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª</div>';
            }
        }
        
        // Populate category filter
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('category-filter');
            const categories = productsManager.categories;
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            
            categoryFilter.addEventListener('change', () => renderProducts());
        }
        
        // Product emojis based on category
        function getProductEmoji(category) {
            const emojis = {
                'Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ Ú¯Ø±Ù…': 'â˜•',
                'Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ Ø³Ø±Ø¯': 'ğŸ¥¤',
                'Ø¯Ø³Ø±': 'ğŸ°',
                'ØºØ°Ø§': 'ğŸ”',
                'ØµØ¨Ø­Ø§Ù†Ù‡': 'ğŸ³',
                'Ø³Ø§Ù„Ø§Ø¯': 'ğŸ¥—'
            };
            return emojis[category] || 'ğŸ½ï¸';
        }
        
        // Render products
        function renderProducts() {
            const container = document.getElementById('products-grid');
            const selectedCategory = document.getElementById('category-filter').value;
            const products = productsManager.getProductsByCategory(selectedCategory);
            
            if (products.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#666;">Ù…Ø­ØµÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                return;
            }
            
            container.innerHTML = products.map(product => `
                <div class="product-card" data-product-id="${product.id}">
                    <div class="product-emoji">${getProductEmoji(product.category)}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${formatPrice(product.price)}</div>
                </div>
            `).join('');
            
            // Add click handlers
            container.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', () => {
                    const productId = parseInt(card.dataset.productId);
                    addToCart(productId);
                    
                    // Visual feedback
                    card.style.transform = 'scale(0.95)';
                    card.style.borderColor = '#28a745';
                    setTimeout(() => {
                        card.style.transform = '';
                        card.style.borderColor = '';
                    }, 150);
                });
            });
        }
        
        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('fa-IR').format(price) + ' ØªÙˆÙ…Ø§Ù†';
        }
        
        // Add product to cart
        function addToCart(productId) {
            const product = productsManager.getProductById(productId);
            if (!product) return;
            
            const existingItem = cart.find(item => item.product.id === productId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ product, quantity: 1 });
            }
            
            renderCart();
            showToast(`${product.name} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`);
        }
        
        // Remove from cart
        function removeFromCart(productId) {
            const index = cart.findIndex(item => item.product.id === productId);
            if (index > -1) {
                cart.splice(index, 1);
            }
            renderCart();
        }
        
        // Update quantity
        function updateQuantity(productId, delta) {
            const item = cart.find(item => item.product.id === productId);
            if (!item) return;
            
            item.quantity += delta;
            
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                renderCart();
            }
        }
        
        // Render cart
        function renderCart() {
            const container = document.getElementById('cart-items');
            
            // Update badges
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const fabBadge = document.getElementById('fab-badge');
            const cartCount = document.getElementById('cart-count');
            
            if (totalItems > 0) {
                fabBadge.textContent = totalItems;
                fabBadge.style.display = 'flex';
                cartCount.textContent = totalItems;
                cartCount.style.display = 'block';
            } else {
                fabBadge.style.display = 'none';
                cartCount.style.display = 'none';
            }
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="cart-empty">
                        <div class="icon">ğŸ›’</div>
                        <p>Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>
                        <small>Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</small>
                    </div>
                `;
                updateTotals();
                return;
            }
            
            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.product.name}</div>
                        <div class="cart-item-price">${formatPrice(item.product.price)}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="quantity-btn" onclick="updateQuantity(${item.product.id}, -1)">âˆ’</button>
                        <span class="quantity-value">${item.quantity}</span>
                        <button class="quantity-btn" onclick="updateQuantity(${item.product.id}, 1)">+</button>
                    </div>
                </div>
            `).join('');
            
            updateTotals();
        }
        
        // Update totals
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const discount = parseInt(document.getElementById('discount').value) || 0;
            const total = Math.max(0, subtotal - discount);
            
            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('discount-amount').textContent = formatPrice(discount);
            document.getElementById('total').textContent = formatPrice(total);
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 1500);
        }
        
        // Clear cart
        document.getElementById('clear-cart-btn').addEventListener('click', () => {
            if (cart.length === 0) return;
            if (confirm('Ø¢ÛŒØ§ Ø³Ø¨Ø¯ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
                cart.length = 0;
                renderCart();
            }
        });
        
        // Discount input
        document.getElementById('discount').addEventListener('input', updateTotals);
        
        // Submit order
        document.getElementById('submit-order-btn').addEventListener('click', async () => {
            if (cart.length === 0) {
                showToast('Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!');
                return;
            }
            
            const tableNumber = document.getElementById('table-number').value || null;
            const discount = parseInt(document.getElementById('discount').value) || 0;
            
            const orderData = {
                table_number: tableNumber ? parseInt(tableNumber) : null,
                discount: discount,
                items: cart.map(item => ({
                    product_id: item.product.id,
                    quantity: item.quantity
                }))
            };
            
            const submitBtn = document.getElementById('submit-order-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';
            
            try {
                await ordersManager.createOrder(orderData);
                cart.length = 0;
                renderCart();
                document.getElementById('table-number').value = '';
                document.getElementById('discount').value = '0';
                
                // Close cart on mobile
                if (window.innerWidth <= 768 && isCartVisible) {
                    toggleCart();
                }
                
                showToast('âœ… Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯!');
                
            } catch (error) {
                console.error('Error creating order:', error);
                showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´';
            }
        });
        
        // Make functions global for onclick handlers
        window.updateQuantity = updateQuantity;
        window.removeFromCart = removeFromCart;
        
        // Load data on page load
        loadProducts();
    </script>
</body>
</html>
