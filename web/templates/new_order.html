<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#6F4E37">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ú©Ø§Ø±Ø¨Ø±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle">â˜°</button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order" class="active">â• Ø³ÙØ§Ø±Ø´</a></li>
                <li><a href="/orders">ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li id="admin-menu-item" style="display: none;"><a href="/admin">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="/dashboard" class="bottom-nav-item">
                <span class="icon">ğŸ </span>
                Ø®Ø§Ù†Ù‡
            </a>
            <a href="/new-order" class="bottom-nav-item active">
                <span class="icon">â•</span>
                Ø³ÙØ§Ø±Ø´
            </a>
            <a href="/orders" class="bottom-nav-item">
                <span class="icon">ğŸ“‹</span>
                Ø³ÙØ§Ø±Ø´Ø§Øª
            </a>
            <a href="#" class="bottom-nav-item" id="show-cart-btn">
                <span class="icon">ğŸ›’</span>
                Ø³Ø¨Ø¯
            </a>
        </div>
    </nav>
    
    <!-- FAB Button -->
    <div class="fab-container" id="fab-container">
        <button class="fab" id="fab-cart" aria-label="Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯">
            ğŸ›’
            <span class="fab-badge" id="fab-badge" style="display:none;">0</span>
        </button>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <div class="container-fluid">
        <div class="order-page">
            <!-- Products Section -->
            <div class="order-products">
                <div class="page-header">
                    <h1>â˜• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</h1>
                    <p>Ù…Ø­ØµÙˆÙ„Ø§Øª Ø±Ø§ Ù„Ù…Ø³ Ú©Ù†ÛŒØ¯</p>
                </div>
                
                <!-- Category Filter -->
                <div class="card" style="padding: 12px 16px;">
                    <select id="category-filter" class="form-select" style="min-height: 50px; font-weight: 600;">
                        <option value="all">ğŸ“‹ Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option>
                    </select>
                </div>
                
                <!-- Products Grid -->
                <div class="products-grid" id="products-grid">
                    <div style="grid-column: 1/-1; padding: 60px 20px;">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Cart Section -->
            <div class="order-sidebar" id="cart-section">
                <div class="order-cart" id="order-cart">
                    <!-- Drag Handle (Mobile) -->
                    <div id="cart-handle" style="width:40px;height:5px;background:#ddd;border-radius:3px;margin:0 auto 16px;display:none;"></div>
                    
                    <div class="cart-header">
                        <h3>
                            ğŸ›’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
                            <span class="cart-count-badge" id="cart-count-badge" style="display:none;">0</span>
                        </h3>
                        <button class="btn btn-sm btn-secondary" id="close-cart-btn" style="display:none;">âœ• Ø¨Ø³ØªÙ†</button>
                    </div>
                    
                    <!-- Table Number -->
                    <div class="form-group">
                        <label class="form-label">ğŸ½ï¸ Ø´Ù…Ø§Ø±Ù‡ Ù…ÛŒØ²</label>
                        <select id="table-number" class="form-select">
                            <option value="">Ø¨ÛŒØ±ÙˆÙ†â€ŒØ¨Ø±</option>
                            <option value="1">Ù…ÛŒØ² Û±</option>
                            <option value="2">Ù…ÛŒØ² Û²</option>
                            <option value="3">Ù…ÛŒØ² Û³</option>
                            <option value="4">Ù…ÛŒØ² Û´</option>
                            <option value="5">Ù…ÛŒØ² Ûµ</option>
                            <option value="6">Ù…ÛŒØ² Û¶</option>
                            <option value="7">Ù…ÛŒØ² Û·</option>
                            <option value="8">Ù…ÛŒØ² Û¸</option>
                            <option value="9">Ù…ÛŒØ² Û¹</option>
                            <option value="10">Ù…ÛŒØ² Û±Û°</option>
                        </select>
                    </div>
                    
                    <!-- Cart Items -->
                    <div class="cart-items" id="cart-items">
                        <div class="cart-empty">
                            <div class="icon">ğŸ›’</div>
                            <p>Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>
                            <small>Ø±ÙˆÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø²Ù†ÛŒØ¯</small>
                        </div>
                    </div>
                    
                    <!-- Discount -->
                    <div class="form-group mt-2">
                        <label class="form-label">ğŸ ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" id="discount" class="form-control" value="0" min="0" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 5000">
                    </div>
                    
                    <!-- Cart Total -->
                    <div class="cart-total">
                        <div class="cart-total-row">
                            <span>Ø¬Ù…Ø¹ Ú©Ù„:</span>
                            <span id="subtotal">Û° ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <div class="cart-total-row">
                            <span>ØªØ®ÙÛŒÙ:</span>
                            <span id="discount-amount" style="color: #EF4444;">- Û° ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <div class="cart-total-row final">
                            <span>ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ:</span>
                            <span id="total">Û° ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="cart-actions">
                        <button id="clear-cart-btn" class="btn btn-secondary">
                            ğŸ—‘ï¸ Ù¾Ø§Ú©
                        </button>
                        <button id="submit-order-btn" class="btn btn-success">
                            âœ… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // ==================== AUTH ====================
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        const user = AuthManager.getUser();
        if (user) {
            document.getElementById('user-info').textContent = user.full_name || user.username;
            if (user.role === 'admin') {
                document.getElementById('admin-menu-item').style.display = 'block';
            }
        }
        
        // ==================== NAVIGATION ====================
        const navToggle = document.getElementById('navbar-toggle');
        const navMenu = document.getElementById('navbar-menu');
        
        navToggle.addEventListener('click', () => {
            navMenu.classList.toggle('mobile-hidden');
        });
        
        document.querySelectorAll('.navbar-menu a').forEach(link => {
            link.addEventListener('click', () => navMenu.classList.add('mobile-hidden'));
        });
        
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            AuthManager.logout();
            window.location.href = '/login';
        });
        
        // ==================== CART STATE ====================
        const cart = [];
        const cartSection = document.getElementById('cart-section');
        const fabCart = document.getElementById('fab-cart');
        const showCartBtn = document.getElementById('show-cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartHandle = document.getElementById('cart-handle');
        let isCartVisible = false;
        
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        function toggleCart() {
            if (!isMobile()) return;
            
            isCartVisible = !isCartVisible;
            if (isCartVisible) {
                cartSection.classList.add('visible');
                closeCartBtn.style.display = 'block';
                cartHandle.style.display = 'block';
                document.body.style.overflow = 'hidden';
            } else {
                cartSection.classList.remove('visible');
                closeCartBtn.style.display = 'none';
                cartHandle.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        fabCart.addEventListener('click', toggleCart);
        showCartBtn.addEventListener('click', (e) => { e.preventDefault(); toggleCart(); });
        closeCartBtn.addEventListener('click', toggleCart);
        
        // Close cart on resize to desktop
        window.addEventListener('resize', () => {
            if (!isMobile() && isCartVisible) {
                isCartVisible = false;
                cartSection.classList.remove('visible');
                closeCartBtn.style.display = 'none';
                cartHandle.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        
        // ==================== TOAST ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        // ==================== PRODUCTS ====================
        const productsManager = new ProductsManager();
        const ordersManager = new OrdersManager();
        
        const categoryEmojis = {
            'Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ Ú¯Ø±Ù…': 'â˜•',
            'Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ Ø³Ø±Ø¯': 'ğŸ§Š',
            'Ø¯Ø³Ø±': 'ğŸ°',
            'ØºØ°Ø§': 'ğŸ”',
            'ØµØ¨Ø­Ø§Ù†Ù‡': 'ğŸ³',
            'Ø³Ø§Ù„Ø§Ø¯': 'ğŸ¥—',
            'default': 'ğŸ½ï¸'
        };
        
        async function loadProducts() {
            try {
                await productsManager.loadProducts();
                populateCategoryFilter();
                renderProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-grid').innerHTML = 
                    '<div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:#888;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>';
            }
        }
        
        function populateCategoryFilter() {
            const filter = document.getElementById('category-filter');
            productsManager.categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = (categoryEmojis[cat] || 'ğŸ“¦') + ' ' + cat;
                filter.appendChild(opt);
            });
            filter.addEventListener('change', renderProducts);
        }
        
        function renderProducts() {
            const container = document.getElementById('products-grid');
            const category = document.getElementById('category-filter').value;
            const products = productsManager.getProductsByCategory(category);
            
            if (products.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:#888;">Ù…Ø­ØµÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                return;
            }
            
            container.innerHTML = products.map((p, i) => `
                <div class="product-card" data-id="${p.id}" style="animation-delay: ${i * 0.03}s;">
                    <div class="product-emoji">${categoryEmojis[p.category] || categoryEmojis.default}</div>
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">${formatPrice(p.price)}</div>
                </div>
            `).join('');
            
            container.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', () => {
                    const id = parseInt(card.dataset.id);
                    addToCart(id);
                    
                    // Visual feedback
                    card.classList.add('added');
                    setTimeout(() => card.classList.remove('added'), 300);
                });
            });
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('fa-IR').format(price) + ' ØªÙˆÙ…Ø§Ù†';
        }
        
        // ==================== CART FUNCTIONS ====================
        function addToCart(productId) {
            const product = productsManager.getProductById(productId);
            if (!product) return;
            
            const existing = cart.find(item => item.product.id === productId);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ product, quantity: 1 });
            }
            
            renderCart();
            showToast('âœ… ' + product.name + ' Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
            
            // Vibrate if supported
            if (navigator.vibrate) navigator.vibrate(50);
        }
        
        function removeFromCart(productId) {
            const index = cart.findIndex(item => item.product.id === productId);
            if (index > -1) cart.splice(index, 1);
            renderCart();
        }
        
        function updateQuantity(productId, delta) {
            const item = cart.find(item => item.product.id === productId);
            if (!item) return;
            
            item.quantity += delta;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                renderCart();
            }
            
            if (navigator.vibrate) navigator.vibrate(30);
        }
        
        function renderCart() {
            const container = document.getElementById('cart-items');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // Update badges
            const fabBadge = document.getElementById('fab-badge');
            const cartBadge = document.getElementById('cart-count-badge');
            
            if (totalItems > 0) {
                fabBadge.textContent = totalItems;
                fabBadge.style.display = 'flex';
                cartBadge.textContent = totalItems;
                cartBadge.style.display = 'inline-flex';
            } else {
                fabBadge.style.display = 'none';
                cartBadge.style.display = 'none';
            }
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="cart-empty">
                        <div class="icon">ğŸ›’</div>
                        <p>Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>
                        <small>Ø±ÙˆÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø²Ù†ÛŒØ¯</small>
                    </div>
                `;
                updateTotals();
                return;
            }
            
            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.product.name}</div>
                        <div class="cart-item-price">${formatPrice(item.product.price * item.quantity)}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="quantity-btn minus" onclick="updateQuantity(${item.product.id}, -1)">âˆ’</button>
                        <span class="quantity-value">${item.quantity}</span>
                        <button class="quantity-btn plus" onclick="updateQuantity(${item.product.id}, 1)">+</button>
                    </div>
                </div>
            `).join('');
            
            updateTotals();
        }
        
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const discount = parseInt(document.getElementById('discount').value) || 0;
            const total = Math.max(0, subtotal - discount);
            
            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('discount-amount').textContent = '- ' + formatPrice(discount);
            document.getElementById('total').textContent = formatPrice(total);
        }
        
        // ==================== ACTIONS ====================
        document.getElementById('discount').addEventListener('input', updateTotals);
        
        document.getElementById('clear-cart-btn').addEventListener('click', () => {
            if (cart.length === 0) return;
            if (confirm('Ø³Ø¨Ø¯ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) {
                cart.length = 0;
                renderCart();
                showToast('ğŸ—‘ï¸ Ø³Ø¨Ø¯ Ù¾Ø§Ú© Ø´Ø¯');
            }
        });
        
        document.getElementById('submit-order-btn').addEventListener('click', async () => {
            if (cart.length === 0) {
                showToast('âŒ Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª', 'error');
                return;
            }
            
            const tableNumber = document.getElementById('table-number').value || null;
            const discount = parseInt(document.getElementById('discount').value) || 0;
            
            const orderData = {
                table_number: tableNumber ? parseInt(tableNumber) : null,
                discount: discount,
                items: cart.map(item => ({
                    product_id: item.product.id,
                    quantity: item.quantity
                }))
            };
            
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true;
            btn.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';
            
            try {
                await ordersManager.createOrder(orderData);
                
                cart.length = 0;
                renderCart();
                document.getElementById('table-number').value = '';
                document.getElementById('discount').value = '0';
                
                if (isMobile() && isCartVisible) toggleCart();
                
                showToast('âœ… Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!');
                
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'âœ… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´';
            }
        });
        
        // Global functions
        window.updateQuantity = updateQuantity;
        window.removeFromCart = removeFromCart;
        
        // Load products
        loadProducts();
    </script>
</body>
</html>
