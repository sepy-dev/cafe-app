<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6F4E37">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ - Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ú©Ø§Ø±Ø¨Ø±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle">â˜°</button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard" class="active">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order">â• Ø³ÙØ§Ø±Ø´</a></li>
                <li><a href="/orders">ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li id="admin-menu-item" style="display: none;"><a href="/admin">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="/dashboard" class="bottom-nav-item active">
                <span class="icon">ğŸ </span>
                Ø®Ø§Ù†Ù‡
            </a>
            <a href="/new-order" class="bottom-nav-item">
                <span class="icon">â•</span>
                Ø³ÙØ§Ø±Ø´
            </a>
            <a href="/orders" class="bottom-nav-item">
                <span class="icon">ğŸ“‹</span>
                Ø³ÙØ§Ø±Ø´Ø§Øª
            </a>
            <a href="#" id="logout-mobile" class="bottom-nav-item">
                <span class="icon">ğŸšª</span>
                Ø®Ø±ÙˆØ¬
            </a>
        </div>
    </nav>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <div class="page-header">
            <h1 id="greeting">ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h1>
            <p id="date-display"></p>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="/new-order" class="quick-action">
                <div class="icon">â•</div>
                <span>Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</span>
            </a>
            <a href="/orders" class="quick-action">
                <div class="icon">ğŸ“‹</div>
                <span>Ù‡Ù…Ù‡ Ø³ÙØ§Ø±Ø´Ø§Øª</span>
            </a>
            <a href="/orders?status=open" class="quick-action">
                <div class="icon">â³</div>
                <span>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
            </a>
            <a href="/admin" class="quick-action" id="admin-action" style="display:none;">
                <div class="icon">ğŸ‘¥</div>
                <span>Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</span>
            </a>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-icon orders">ğŸ“¦</div>
                <div class="stat-content">
                    <h3 id="total-orders">-</h3>
                    <p>Ø³ÙØ§Ø±Ø´ Ø§Ù…Ø±ÙˆØ²</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon revenue">ğŸ’°</div>
                <div class="stat-content">
                    <h3 id="total-revenue">-</h3>
                    <p>Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon pending">â³</div>
                <div class="stat-content">
                    <h3 id="pending-orders">-</h3>
                    <p>Ø³ÙØ§Ø±Ø´ Ø¨Ø§Ø²</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon products">â˜•</div>
                <div class="stat-content">
                    <h3 id="total-products">-</h3>
                    <p>Ù…Ø­ØµÙˆÙ„ ÙØ¹Ø§Ù„</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Orders -->
        <div class="card">
            <div class="card-header">ğŸ“‹ Ø¢Ø®Ø±ÛŒÙ† Ø³ÙØ§Ø±Ø´Ø§Øª</div>
            <div id="recent-orders">
                <div class="spinner"></div>
            </div>
            <a href="/orders" class="btn btn-secondary btn-block mt-2">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡ Ø³ÙØ§Ø±Ø´Ø§Øª</a>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Auth check
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        // User info
        const user = AuthManager.getUser();
        if (user) {
            document.getElementById('user-info').textContent = user.full_name || user.username;
            
            // Greeting based on time
            const hour = new Date().getHours();
            let greeting = 'ğŸ‘‹ ';
            if (hour < 12) greeting += 'ØµØ¨Ø­ Ø¨Ø®ÛŒØ±';
            else if (hour < 17) greeting += 'Ø¸Ù‡Ø± Ø¨Ø®ÛŒØ±';
            else greeting += 'Ø¹ØµØ± Ø¨Ø®ÛŒØ±';
            greeting += 'ØŒ ' + (user.full_name || user.username) + '!';
            document.getElementById('greeting').textContent = greeting;
            
            if (user.role === 'admin') {
                document.getElementById('admin-menu-item').style.display = 'block';
                document.getElementById('admin-action').style.display = 'block';
            }
        }
        
        // Date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('date-display').textContent = 
            new Date().toLocaleDateString('fa-IR', options);
        
        // Navigation
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            document.getElementById('navbar-menu').classList.toggle('mobile-hidden');
        });
        
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            AuthManager.logout();
            window.location.href = '/login';
        });
        
        document.getElementById('logout-mobile').addEventListener('click', (e) => {
            e.preventDefault();
            AuthManager.logout();
            window.location.href = '/login';
        });
        
        // Toast
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        // Format price
        function formatPrice(price) {
            if (price >= 1000000) {
                return (price / 1000000).toFixed(1) + 'M';
            } else if (price >= 1000) {
                return Math.round(price / 1000) + 'K';
            }
            return new Intl.NumberFormat('fa-IR').format(price);
        }
        
        // Load dashboard
        async function loadDashboard() {
            try {
                const dashboard = new DashboardManager();
                const stats = await dashboard.loadStats();
                
                if (stats) {
                    document.getElementById('total-orders').textContent = 
                        new Intl.NumberFormat('fa-IR').format(stats.today_orders || 0);
                    document.getElementById('total-revenue').textContent = 
                        formatPrice(stats.today_revenue || 0) + ' Øª';
                    document.getElementById('pending-orders').textContent = 
                        new Intl.NumberFormat('fa-IR').format(stats.pending_orders || 0);
                    document.getElementById('total-products').textContent = 
                        new Intl.NumberFormat('fa-IR').format(stats.products_count || 0);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
            
            // Recent orders
            try {
                const ordersManager = new OrdersManager();
                const orders = await ordersManager.loadOrders();
                const container = document.getElementById('recent-orders');
                
                if (orders && orders.length > 0) {
                    const recent = orders.slice(0, 5);
                    container.innerHTML = recent.map(order => `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #f0f0f0;" onclick="window.location='/orders'">
                            <div>
                                <strong style="color:#333;">#${order.id}</strong>
                                <span style="color:#888;margin-right:8px;font-size:0.9rem;">
                                    ${order.table_number ? 'ğŸ½ï¸ Ù…ÛŒØ² ' + order.table_number : 'ğŸ›ï¸ Ø¨ÛŒØ±ÙˆÙ†â€ŒØ¨Ø±'}
                                </span>
                            </div>
                            <div style="text-align:left;">
                                <span class="badge ${order.status === 'open' ? 'badge-warning' : 'badge-success'}">
                                    ${order.status === 'open' ? 'â³ Ø¨Ø§Ø²' : 'âœ… Ø¨Ø³ØªÙ‡'}
                                </span>
                                <div style="font-size:0.85rem;color:#666;margin-top:4px;font-weight:600;">
                                    ${new Intl.NumberFormat('fa-IR').format(order.total || 0)} Øª
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="text-align:center;color:#888;padding:40px 20px;">Ù‡Ù†ÙˆØ² Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('recent-orders').innerHTML = 
                    '<p style="text-align:center;color:#888;padding:40px 20px;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>';
            }
        }
        
        loadDashboard();
        
        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
