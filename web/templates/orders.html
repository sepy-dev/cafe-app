<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6F4E37">
    <title>Ø³ÙØ§Ø±Ø´Ø§Øª - Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ú©Ø§Ø±Ø¨Ø±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle">â˜°</button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order">â• Ø³ÙØ§Ø±Ø´</a></li>
                <li><a href="/orders" class="active">ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li id="admin-menu-item" style="display: none;"><a href="/admin">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="/dashboard" class="bottom-nav-item">
                <span class="icon">ğŸ </span>
                Ø®Ø§Ù†Ù‡
            </a>
            <a href="/new-order" class="bottom-nav-item">
                <span class="icon">â˜•</span>
                Ù…Ù†Ùˆ
            </a>
            <a href="/orders" class="bottom-nav-item active">
                <span class="icon">ğŸ“‹</span>
                Ø³ÙØ§Ø±Ø´Ø§Øª
            </a>
            <a href="#" id="refresh-btn-mobile" class="bottom-nav-item">
                <span class="icon">ğŸ”„</span>
                Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
            </a>
        </div>
    </nav>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <div class="page-header">
            <h1>ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</h1>
            <p>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</p>
        </div>
        
        <!-- Filters -->
        <div class="card" style="padding: 12px;">
            <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;">
                <select id="status-filter" class="form-select" style="min-height:48px;">
                    <option value="all">ğŸ“‹ Ù‡Ù…Ù‡ Ø³ÙØ§Ø±Ø´Ø§Øª</option>
                    <option value="open">â³ Ø³ÙØ§Ø±Ø´Ø§Øª Ø¨Ø§Ø²</option>
                    <option value="closed">âœ… Ø³ÙØ§Ø±Ø´Ø§Øª Ø¨Ø³ØªÙ‡</option>
                </select>
                <button id="refresh-btn" class="btn btn-secondary btn-icon">ğŸ”„</button>
            </div>
        </div>
        
        <!-- Orders List -->
        <div id="orders-container">
            <div class="card" style="padding:40px;">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <!-- Order Details/Edit Modal -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´</h2>
                <span class="modal-close" onclick="closeModal()">âœ•</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Auth
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        const user = AuthManager.getUser();
        if (user) {
            document.getElementById('user-info').textContent = user.full_name || user.username;
            if (user.role === 'admin') {
                document.getElementById('admin-menu-item').style.display = 'block';
            }
        }
        
        // Navigation
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            document.getElementById('navbar-menu').classList.toggle('mobile-hidden');
        });
        
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            AuthManager.logout();
            window.location.href = '/login';
        });
        
        // Toast
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        // Data
        const ordersManager = new OrdersManager();
        let currentOrders = [];
        
        function formatPrice(price) {
            return new Intl.NumberFormat('fa-IR').format(price) + ' Øª';
        }
        
        function getTimeAgo(dateStr) {
            if (!dateStr) return '';
            const diff = Date.now() - new Date(dateStr).getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'Ø§Ù„Ø§Ù†';
            if (mins < 60) return mins + ' Ø¯Ù‚ÛŒÙ‚Ù‡';
            const hours = Math.floor(mins / 60);
            if (hours < 24) return hours + ' Ø³Ø§Ø¹Øª';
            return Math.floor(hours / 24) + ' Ø±ÙˆØ²';
        }
        
        // Load orders
        async function loadOrders() {
            const container = document.getElementById('orders-container');
            container.innerHTML = '<div class="card" style="padding:60px;"><div class="spinner"></div></div>';
            
            try {
                const orders = await ordersManager.loadOrders();
                currentOrders = orders || [];
                renderOrders();
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#888;padding:40px;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p></div>';
            }
        }
        
        function renderOrders() {
            const container = document.getElementById('orders-container');
            const filter = document.getElementById('status-filter').value;
            
            let orders = currentOrders;
            if (filter !== 'all') {
                orders = currentOrders.filter(o => o.status === filter);
            }
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#888;padding:60px 20px;">ğŸ“‹ Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p></div>';
                return;
            }
            
            container.innerHTML = orders.map((order, i) => {
                // Get items summary
                const itemsList = order.items && order.items.length > 0 
                    ? order.items.map(item => `
                        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f5f5f5;font-size:0.9rem;">
                            <span style="color:#555;">
                                <strong style="color:#333;">${item.quantity}Ã—</strong> ${item.product_name || item.name}
                            </span>
                            <span style="font-weight:600;color:#6F4E37;">${formatPrice(item.unit_price * item.quantity)}</span>
                        </div>
                    `).join('')
                    : '<p style="color:#999;font-size:0.85rem;padding:8px 0;">Ø¨Ø¯ÙˆÙ† Ø¢ÛŒØªÙ…</p>';
                
                return `
                <div class="card" style="animation-delay:${i*0.03}s;cursor:pointer;" onclick="showOrder(${order.id})">
                    <!-- Header -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:1.5rem;">${order.table_number ? 'ğŸ½ï¸' : 'ğŸ›ï¸'}</span>
                            <div>
                                <strong style="font-size:1.1rem;color:#333;">#${order.id}</strong>
                                <span style="color:#888;font-size:0.85rem;margin-right:8px;">
                                    ${order.table_number ? 'Ù…ÛŒØ² ' + order.table_number : 'Ø¨ÛŒØ±ÙˆÙ†â€ŒØ¨Ø±'}
                                </span>
                            </div>
                        </div>
                        <span class="badge ${order.status === 'open' ? 'badge-warning' : 'badge-success'}">
                            ${order.status === 'open' ? 'â³ Ø¨Ø§Ø²' : 'âœ… Ø¨Ø³ØªÙ‡'}
                        </span>
                    </div>
                    
                    <!-- Items List -->
                    <div style="background:#fafafa;border-radius:10px;padding:8px 12px;margin-bottom:12px;">
                        ${itemsList}
                    </div>
                    
                    <!-- Footer -->
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="color:#999;font-size:0.8rem;">ğŸ• ${getTimeAgo(order.created_at)} Ù¾ÛŒØ´</span>
                        <div style="text-align:left;">
                            ${order.discount > 0 ? `<span style="color:#EF4444;font-size:0.8rem;margin-left:8px;">-${formatPrice(order.discount)}</span>` : ''}
                            <strong style="font-size:1.15rem;color:#6F4E37;">${formatPrice(order.total || 0)}</strong>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    ${order.status === 'open' ? `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;padding-top:12px;border-top:1px dashed #eee;" onclick="event.stopPropagation();">
                        <button class="btn btn-primary btn-sm" onclick="editOrder(${order.id})">
                            âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´
                        </button>
                        <button class="btn btn-success btn-sm" onclick="closeOrderQuick(${order.id})">
                            âœ… Ø¨Ø³ØªÙ†
                        </button>
                    </div>
                    ` : ''}
                </div>
            `}).join('');
        }
        
        function showOrder(orderId) {
            const order = currentOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.getElementById('order-modal');
            document.getElementById('modal-title').textContent = 'â˜• Ø³ÙØ§Ø±Ø´ #' + order.id;
            
            const subtotal = order.items ? order.items.reduce((s, i) => s + ((i.unit_price || i.price) * i.quantity), 0) : 0;
            
            document.getElementById('modal-body').innerHTML = `
                <div style="margin-bottom:16px;">
                    <span class="badge ${order.status === 'open' ? 'badge-warning' : 'badge-success'}" style="font-size:0.95rem;">
                        ${order.status === 'open' ? 'â³ Ø³ÙØ§Ø±Ø´ Ø¨Ø§Ø²' : 'âœ… Ø³ÙØ§Ø±Ø´ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡'}
                    </span>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
                    <div style="background:#f8f8f8;padding:14px;border-radius:12px;text-align:center;">
                        <div style="font-size:1.5rem;margin-bottom:4px;">${order.table_number ? 'ğŸ½ï¸' : 'ğŸ›ï¸'}</div>
                        <strong>${order.table_number ? 'Ù…ÛŒØ² ' + order.table_number : 'Ø¨ÛŒØ±ÙˆÙ†â€ŒØ¨Ø±'}</strong>
                    </div>
                    <div style="background:#f8f8f8;padding:14px;border-radius:12px;text-align:center;">
                        <div style="font-size:1.5rem;margin-bottom:4px;">ğŸ•</div>
                        <strong style="font-size:0.9rem;">${getTimeAgo(order.created_at)} Ù¾ÛŒØ´</strong>
                    </div>
                </div>
                
                <h4 style="margin-bottom:12px;color:#333;display:flex;align-items:center;gap:8px;">
                    â˜• Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´
                    <span style="background:#6F4E37;color:white;font-size:0.75rem;padding:2px 8px;border-radius:10px;">${order.items ? order.items.length : 0} Ø¢ÛŒØªÙ…</span>
                </h4>
                <div style="background:#f8f8f8;border-radius:12px;overflow:hidden;margin-bottom:20px;">
                    ${order.items && order.items.length > 0 ? order.items.map(item => `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eee;">
                            <div>
                                <strong style="font-size:1rem;color:#333;">${item.product_name || item.name}</strong>
                                <div style="color:#888;font-size:0.85rem;margin-top:2px;">
                                    ${item.quantity} Ø¹Ø¯Ø¯ Ã— ${formatPrice(item.unit_price || item.price)}
                                </div>
                            </div>
                            <strong style="font-size:1.05rem;color:#6F4E37;">${formatPrice((item.unit_price || item.price) * item.quantity)}</strong>
                        </div>
                    `).join('') : '<p style="padding:20px;text-align:center;color:#888;">Ø¨Ø¯ÙˆÙ† Ø¢ÛŒØªÙ…</p>'}
                </div>
                
                <div style="border-top:2px dashed #ddd;padding-top:16px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.95rem;">
                        <span>Ø¬Ù…Ø¹ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:</span>
                        <span>${formatPrice(subtotal)}</span>
                    </div>
                    ${order.discount > 0 ? `
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.95rem;color:#EF4444;">
                        <span>ğŸ ØªØ®ÙÛŒÙ:</span>
                        <span>- ${formatPrice(order.discount)}</span>
                    </div>
                    ` : ''}
                    <div style="display:flex;justify-content:space-between;font-size:1.3rem;font-weight:800;color:#6F4E37;padding-top:12px;border-top:2px solid #eee;">
                        <span>ğŸ’° Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                        <span>${formatPrice(order.total || 0)}</span>
                    </div>
                </div>
                
                ${order.status === 'open' ? `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px;">
                        <button class="btn btn-primary" onclick="editOrder(${order.id})" style="font-size:1rem;">
                            âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´
                        </button>
                        <button class="btn btn-success" onclick="closeOrder(${order.id})" style="font-size:1rem;">
                            âœ… Ø¨Ø³ØªÙ† Ø³ÙØ§Ø±Ø´
                        </button>
                    </div>
                ` : `
                    <div style="margin-top:20px;">
                        <button class="btn btn-secondary btn-block" onclick="closeModal()">
                            âœ• Ø¨Ø³ØªÙ†
                        </button>
                    </div>
                `}
            `;
            
            modal.classList.add('show');
        }
        
        function editOrder(orderId) {
            // Redirect to new order page with order data
            sessionStorage.setItem('edit_order_id', orderId);
            window.location.href = '/new-order?edit=' + orderId;
        }
        
        function closeModal() {
            document.getElementById('order-modal').classList.remove('show');
        }
        
        async function closeOrder(orderId) {
            if (!confirm('Ø³ÙØ§Ø±Ø´ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯ØŸ')) return;
            await doCloseOrder(orderId);
        }
        
        async function closeOrderQuick(orderId) {
            await doCloseOrder(orderId);
        }
        
        async function doCloseOrder(orderId) {
            try {
                await ordersManager.updateOrderStatus(orderId, 'closed');
                closeModal();
                showToast('âœ… Ø³ÙØ§Ø±Ø´ Ø¨Ø³ØªÙ‡ Ø´Ø¯');
                loadOrders();
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            } catch (error) {
                console.error('Error:', error);
                showToast('âŒ Ø®Ø·Ø§', 'error');
            }
        }
        
        // Events
        document.getElementById('status-filter').addEventListener('change', renderOrders);
        document.getElementById('refresh-btn').addEventListener('click', loadOrders);
        document.getElementById('refresh-btn-mobile').addEventListener('click', (e) => {
            e.preventDefault();
            loadOrders();
            showToast('ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
        });
        
        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target.id === 'order-modal') closeModal();
        });
        
        // URL params
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('status')) {
            document.getElementById('status-filter').value = urlParams.get('status');
        }
        
        // Globals
        window.showOrder = showOrder;
        window.closeModal = closeModal;
        window.closeOrder = closeOrder;
        window.closeOrderQuick = closeOrderQuick;
        window.editOrder = editOrder;
        
        // Load
        loadOrders();
        
        // Auto refresh every 30 seconds
        setInterval(loadOrders, 30000);
    </script>
</body>
</html>
