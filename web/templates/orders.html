<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8b4513">
    <title>Ø³ÙØ§Ø±Ø´Ø§Øª - Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ú©Ø§Ø±Ø¨Ø±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle">â˜°</button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order">â• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</a></li>
                <li><a href="/orders" class="active">ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li id="admin-menu-item" style="display: none;"><a href="/admin">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="/dashboard" class="bottom-nav-item">
                <span class="icon">ğŸ“Š</span>
                Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
            </a>
            <a href="/new-order" class="bottom-nav-item">
                <span class="icon">â•</span>
                Ø³ÙØ§Ø±Ø´
            </a>
            <a href="/orders" class="bottom-nav-item active">
                <span class="icon">ğŸ“‹</span>
                Ø³ÙØ§Ø±Ø´Ø§Øª
            </a>
            <a href="#" id="refresh-btn-mobile" class="bottom-nav-item">
                <span class="icon">ğŸ”„</span>
                Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
            </a>
        </div>
    </nav>
    
    <div class="container">
        <div class="page-header">
            <h1>ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª</h1>
            <p>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</p>
        </div>
        
        <!-- Filters -->
        <div class="card">
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <select id="status-filter" class="form-select" style="flex:1;min-width:150px;">
                    <option value="all">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                    <option value="open">â³ Ø¨Ø§Ø²</option>
                    <option value="closed">âœ… Ø¨Ø³ØªÙ‡</option>
                </select>
                <button id="refresh-btn" class="btn btn-secondary">
                    ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                </button>
            </div>
        </div>
        
        <!-- Orders List -->
        <div id="orders-container">
            <div class="card">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´</h2>
                <span class="modal-close" onclick="closeModal()">âœ•</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="alert alert-success" style="position:fixed;bottom:100px;left:50%;transform:translateX(-50%);z-index:9999;display:none;min-width:280px;text-align:center;"></div>
    
    <script src="/static/app.js"></script>
    <script>
        // Check authentication
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        // Get user info
        const user = AuthManager.getUser();
        if (user) {
            document.getElementById('user-info').textContent = user.full_name || user.username;
            if (user.role === 'admin') {
                document.getElementById('admin-menu-item').style.display = 'block';
            }
        }
        
        // Mobile navigation toggle
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('mobile-hidden');
        });
        
        // Logout
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            AuthManager.logout();
            window.location.href = '/login';
        });
        
        // Orders Manager
        const ordersManager = new OrdersManager();
        let currentOrders = [];
        
        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('fa-IR').format(price) + ' ØªÙˆÙ…Ø§Ù†';
        }
        
        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fa-IR') + ' ' + date.toLocaleTimeString('fa-IR', {hour:'2-digit',minute:'2-digit'});
        }
        
        // Load orders
        async function loadOrders() {
            const container = document.getElementById('orders-container');
            container.innerHTML = '<div class="card"><div class="spinner"></div></div>';
            
            try {
                const orders = await ordersManager.loadOrders();
                currentOrders = orders || [];
                renderOrders();
            } catch (error) {
                console.error('Error loading orders:', error);
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#666;padding:20px;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª</p></div>';
            }
        }
        
        // Render orders
        function renderOrders() {
            const container = document.getElementById('orders-container');
            const statusFilter = document.getElementById('status-filter').value;
            
            let filteredOrders = currentOrders;
            if (statusFilter !== 'all') {
                filteredOrders = currentOrders.filter(o => o.status === statusFilter);
            }
            
            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#666;padding:40px;">Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p></div>';
                return;
            }
            
            container.innerHTML = filteredOrders.map(order => `
                <div class="card" style="cursor:pointer;" onclick="showOrderDetails(${order.id})">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <h3 style="margin:0;color:var(--primary-color);">Ø³ÙØ§Ø±Ø´ #${order.id}</h3>
                            <p style="margin:8px 0 0;color:#666;">
                                ${order.table_number ? 'ğŸ½ï¸ Ù…ÛŒØ² ' + order.table_number : 'ğŸ›ï¸ Ø¨ÛŒØ±ÙˆÙ†â€ŒØ¨Ø±'}
                            </p>
                            <p style="margin:4px 0 0;font-size:0.85rem;color:#999;">
                                ${formatDate(order.created_at)}
                            </p>
                        </div>
                        <div style="text-align:left;">
                            <span class="badge ${order.status === 'open' ? 'badge-warning' : 'badge-success'}">
                                ${order.status === 'open' ? 'â³ Ø¨Ø§Ø²' : 'âœ… Ø¨Ø³ØªÙ‡'}
                            </span>
                            <p style="margin:8px 0 0;font-weight:700;color:var(--primary-color);">
                                ${formatPrice(order.total || 0)}
                            </p>
                        </div>
                    </div>
                    ${order.items && order.items.length > 0 ? `
                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #eee;font-size:0.9rem;color:#666;">
                            ${order.items.slice(0,3).map(item => `${item.name} (${item.quantity})`).join('ØŒ ')}
                            ${order.items.length > 3 ? '...' : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Show order details
        function showOrderDetails(orderId) {
            const order = currentOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.getElementById('order-modal');
            const modalBody = document.getElementById('modal-body');
            
            document.getElementById('modal-title').textContent = `Ø³ÙØ§Ø±Ø´ #${order.id}`;
            
            const subtotal = order.items ? order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0) : 0;
            
            modalBody.innerHTML = `
                <div style="margin-bottom:16px;">
                    <span class="badge ${order.status === 'open' ? 'badge-warning' : 'badge-success'}">
                        ${order.status === 'open' ? 'â³ Ø¨Ø§Ø²' : 'âœ… Ø¨Ø³ØªÙ‡'}
                    </span>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
                    <div>
                        <small style="color:#666;">Ù…ÛŒØ²</small>
                        <p style="margin:4px 0;font-weight:600;">${order.table_number ? 'Ù…ÛŒØ² ' + order.table_number : 'Ø¨ÛŒØ±ÙˆÙ†â€ŒØ¨Ø±'}</p>
                    </div>
                    <div>
                        <small style="color:#666;">ØªØ§Ø±ÛŒØ®</small>
                        <p style="margin:4px 0;font-weight:600;">${formatDate(order.created_at)}</p>
                    </div>
                </div>
                
                <h4 style="margin-bottom:12px;">Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</h4>
                <div style="background:#f8f9fa;border-radius:12px;padding:12px;margin-bottom:16px;">
                    ${order.items && order.items.length > 0 ? order.items.map(item => `
                        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                            <span>${item.name} Ã— ${item.quantity}</span>
                            <span>${formatPrice(item.price * item.quantity)}</span>
                        </div>
                    `).join('') : '<p style="color:#666;text-align:center;">Ø¨Ø¯ÙˆÙ† Ø¢ÛŒØªÙ…</p>'}
                </div>
                
                <div style="border-top:2px solid #eee;padding-top:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>Ø¬Ù…Ø¹:</span>
                        <span>${formatPrice(subtotal)}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>ØªØ®ÙÛŒÙ:</span>
                        <span>${formatPrice(order.discount || 0)}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:1.2rem;font-weight:700;color:var(--primary-color);">
                        <span>Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ:</span>
                        <span>${formatPrice(order.total || 0)}</span>
                    </div>
                </div>
                
                ${order.status === 'open' ? `
                    <div style="margin-top:20px;display:flex;gap:10px;">
                        <button class="btn btn-success btn-block" onclick="closeOrder(${order.id})">
                            âœ… Ø¨Ø³ØªÙ† Ø³ÙØ§Ø±Ø´
                        </button>
                    </div>
                ` : ''}
            `;
            
            modal.classList.add('show');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('order-modal').classList.remove('show');
        }
        
        // Close order
        async function closeOrder(orderId) {
            if (!confirm('Ø¢ÛŒØ§ Ø³ÙØ§Ø±Ø´ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯ØŸ')) return;
            
            try {
                await ordersManager.updateOrderStatus(orderId, 'closed');
                closeModal();
                showToast('âœ… Ø³ÙØ§Ø±Ø´ Ø¨Ø³ØªÙ‡ Ø´Ø¯');
                loadOrders();
            } catch (error) {
                console.error('Error closing order:', error);
                showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø³ØªÙ† Ø³ÙØ§Ø±Ø´');
            }
        }
        
        // Show toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }
        
        // Event listeners
        document.getElementById('status-filter').addEventListener('change', renderOrders);
        document.getElementById('refresh-btn').addEventListener('click', loadOrders);
        document.getElementById('refresh-btn-mobile').addEventListener('click', (e) => {
            e.preventDefault();
            loadOrders();
        });
        
        // Close modal on background click
        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target.id === 'order-modal') closeModal();
        });
        
        // Check URL params for status filter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('status')) {
            document.getElementById('status-filter').value = urlParams.get('status');
        }
        
        // Make functions global
        window.showOrderDetails = showOrderDetails;
        window.closeModal = closeModal;
        window.closeOrder = closeOrder;
        
        // Load orders on page load
        loadOrders();
    </script>
</body>
</html>
