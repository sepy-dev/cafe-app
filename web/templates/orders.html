<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª - Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§ÙÙ‡</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-brand">â˜• Ú©Ø§ÙÙ‡</a>
            <div class="navbar-user">
                <span class="user-badge" id="user-info">Ú©Ø§Ø±Ø¨Ø±</span>
                <a href="#" id="logout-btn" class="btn btn-secondary btn-sm">Ø®Ø±ÙˆØ¬</a>
            </div>
            <button class="navbar-toggle" id="navbar-toggle" aria-label="Ù…Ù†ÙˆÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ">
                â˜°
            </button>
            <ul class="navbar-menu mobile-hidden" id="navbar-menu">
                <li><a href="/dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a></li>
                <li><a href="/new-order">â• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</a></li>
                <li><a href="/orders" class="active">ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                <li id="admin-menu-item" style="display: none;"><a href="/admin">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <div style="margin: 30px 0;">
            <h1 style="color: var(--primary-color); margin-bottom: 10px;">ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</h1>
            <p style="color: var(--text-secondary);">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</p>
        </div>
        
        <!-- Filters -->
        <div class="card">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="status-filter">ÙÛŒÙ„ØªØ± ÙˆØ¶Ø¹ÛŒØª:</label>
                <select id="status-filter" class="form-select">
                    <option value="">Ù‡Ù…Ù‡ Ø³ÙØ§Ø±Ø´Ø§Øª</option>
                    <option value="open">Ø¨Ø§Ø²</option>
                    <option value="closed">Ø¨Ø³ØªÙ‡</option>
                    <option value="cancelled">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                </select>
            </div>
        </div>
        
        <!-- Orders Table -->
        <div class="card">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“‹ Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´Ø§Øª</span>
                    <button id="refresh-btn" class="btn btn-primary btn-sm">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                </div>
            </div>
            <div class="card-body">
                <div id="orders-container">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´</h2>
                <span class="modal-close" onclick="closeOrderModal()">Ã—</span>
            </div>
            <div id="order-details-container"></div>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Check authentication
        if (!AuthManager.isAuthenticated()) {
            window.location.href = '/login';
        }
        
        // Show admin menu if user is admin
        const user = AuthManager.getUser();
        if (user && user.role === 'admin') {
            document.getElementById('admin-menu-item').style.display = 'block';
        }
        
        // Mobile navigation toggle
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('mobile-hidden');
        });
        
        // Close menu when clicking a link
        document.querySelectorAll('.navbar-menu a').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navbar-menu').classList.add('mobile-hidden');
            });
        });
        
        // Orders Manager
        const ordersManager = new OrdersManager();
        let currentOrders = [];
        
        // Load orders
        async function loadOrders() {
            const statusFilter = document.getElementById('status-filter').value;
            
            try {
                currentOrders = await ordersManager.loadOrders(statusFilter || null);
                renderOrders();
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }
        
        // Render orders
        function renderOrders() {
            const container = document.getElementById('orders-container');
            
            if (currentOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ø´Ù…Ø§Ø±Ù‡</th>
                            <th>Ù…ÛŒØ²</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…</th>
                            <th>Ù…Ø¨Ù„Øº Ú©Ù„</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>ØªØ§Ø±ÛŒØ®</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentOrders.map(order => `
                            <tr>
                                <td><strong>#${order.id}</strong></td>
                                <td>${order.table_number || '-'}</td>
                                <td>${order.items.length} Ø¢ÛŒØªÙ…</td>
                                <td style="color: var(--primary-color); font-weight: bold;">${UI.formatCurrency(order.total)}</td>
                                <td><span class="badge ${UI.getStatusBadgeClass(order.status)}">${UI.getStatusText(order.status)}</span></td>
                                <td>${UI.formatDate(order.created_at)}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="showOrderDetails(${order.id})">Ø¬Ø²Ø¦ÛŒØ§Øª</button>
                                    ${order.status === 'open' ? `
                                        <button class="btn btn-sm btn-success" onclick="updateStatus(${order.id}, 'closed')">Ø¨Ø³ØªÙ†</button>
                                        <button class="btn btn-sm btn-danger" onclick="updateStatus(${order.id}, 'cancelled')">Ù„ØºÙˆ</button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }
        
        // Show order details
        async function showOrderDetails(orderId) {
            const order = currentOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const container = document.getElementById('order-details-container');
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color);">Ø³ÙØ§Ø±Ø´ #${order.id}</h3>
                    <p style="color: var(--text-secondary);">
                        Ù…ÛŒØ²: ${order.table_number || 'Ù†Ø§Ù…Ø´Ø®Øµ'} | 
                        ØªØ§Ø±ÛŒØ®: ${UI.formatDate(order.created_at)} | 
                        ÙˆØ¶Ø¹ÛŒØª: <span class="badge ${UI.getStatusBadgeClass(order.status)}">${UI.getStatusText(order.status)}</span>
                    </p>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ù…Ø­ØµÙˆÙ„</th>
                            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯</th>
                            <th>Ø¬Ù…Ø¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${item.product_name}</td>
                                <td>${UI.formatCurrency(item.unit_price)}</td>
                                <td>${item.quantity}</td>
                                <td>${UI.formatCurrency(item.total)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--secondary-color); border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Ø¬Ù…Ø¹ Ø¬Ø²Ø¡:</span>
                        <strong>${UI.formatCurrency(order.subtotal)}</strong>
                    </div>
                    ${order.discount > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--danger-color);">
                            <span>ØªØ®ÙÛŒÙ:</span>
                            <strong>-${UI.formatCurrency(order.discount)}</strong>
                        </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; font-size: 1.2rem; padding-top: 10px; border-top: 2px solid var(--primary-color);">
                        <span>Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ:</span>
                        <strong style="color: var(--primary-color);">${UI.formatCurrency(order.total)}</strong>
                    </div>
                </div>
                
                ${order.status === 'open' ? `
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="updateStatus(${order.id}, 'closed'); closeOrderModal();">Ø¨Ø³ØªÙ† Ø³ÙØ§Ø±Ø´</button>
                        <button class="btn btn-danger" onclick="updateStatus(${order.id}, 'cancelled'); closeOrderModal();">Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´</button>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('order-modal').classList.add('show');
        }
        
        // Close order modal
        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('show');
        }
        
        // Update order status
        async function updateStatus(orderId, newStatus) {
            if (!confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŸ`)) {
                return;
            }
            
            try {
                await ordersManager.updateOrderStatus(orderId, newStatus);
                await loadOrders();
            } catch (error) {
                console.error('Error updating order status:', error);
            }
        }
        
        // Event listeners
        document.getElementById('status-filter').addEventListener('change', loadOrders);
        document.getElementById('refresh-btn').addEventListener('click', loadOrders);
        
        // Close modal on background click
        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target.id === 'order-modal') {
                closeOrderModal();
            }
        });
        
        // Make functions global
        window.showOrderDetails = showOrderDetails;
        window.closeOrderModal = closeOrderModal;
        window.updateStatus = updateStatus;
        
        // Load orders on page load
        loadOrders();
        
        // Auto-refresh every 30 seconds
        setInterval(loadOrders, 30000);
    </script>
</body>
</html>
